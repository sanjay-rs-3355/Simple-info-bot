<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voice Wiki Chatbot</title>
<style>

/* ===== BASE LAYOUT ===== */
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #1c1c3c);
  background-size: 400% 400%;
  animation: gradientMove 15s ease infinite;
  color: white;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ===== HEADER ===== */
header {
  height: 70px;
  width: 96.7%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  animation: slideDown 0.8s ease forwards;
}

#welcomeUser {
  font-size: 16px;
  font-weight: 600;
}

header div:last-child {
  display: flex;
  gap: 10px;
}

header button {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: white;
  cursor: pointer;
  transition: 0.3s;
}

header button:hover {
  background: rgba(255,255,255,0.3);
}

/* ===== CHAT AREA ===== */
#chatbox {
  flex: 1;
  padding: 25px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 14px;
  scroll-behavior: smooth;
}

/* ===== MESSAGE BUBBLES ===== */
.user-msg,
.ai-msg {
  padding: 14px 20px;
  border-radius: 20px;
  max-width: 70%;
  font-size: 14px;
  line-height: 1.5;
}

.user-msg {
  align-self: flex-end;
  background: linear-gradient(135deg, #43cea2, #185a9d);
  animation: slideRight 0.3s ease;
}

.ai-msg {
  align-self: flex-start;
  background: rgba(255,255,255,0.1);
  animation: slideLeft 0.3s ease;
}

.timestamp {
  display: block;
  font-size: 10px;
  margin-top: 6px;
  opacity: 0.6;
}

/* ===== INPUT AREA ===== */
#input-area {
  padding: 18px 25px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(255,255,255,0.05);
  border-top: 1px solid rgba(255,255,255,0.1);
}

#userInput {
  flex: 1;
  padding: 14px 20px;
  border-radius: 30px;
  border: none;
  outline: none;
  font-size: 14px;
  background: rgba(255,255,255,0.1);
  color: white;
  transition: 0.3s;
}

#userInput:focus {
  box-shadow: 0 0 15px rgba(67,206,162,0.5);
}

#sendBtn, #micBtn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 18px;
  transition: 0.3s;
}

#sendBtn {
  background: linear-gradient(45deg, #43cea2, #185a9d);
}

#sendBtn:hover {
  transform: scale(1.1);
}

#micBtn {
  background: linear-gradient(45deg, #2196f3, #1e88e5);
}

#micBtn:hover {
  transform: scale(1.1);
}

/* ===== ANIMATIONS ===== */
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideRight {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes slideLeft {
  from { opacity: 0; transform: translateX(-40px); }
  to { opacity: 1; transform: translateX(0); }
}

/* Floating glow circles */
body::before,
body::after {
  content: "";
  position: fixed;
  width: 300px;
  height: 300px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,0.15), transparent);
  animation: floatMove 12s ease-in-out infinite;
  z-index: -1;
}

body::before { top: -100px; left: -100px; }
body::after { bottom: -100px; right: -100px; animation-delay: 6s; }

@keyframes floatMove {
  0%,100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(40px) rotate(10deg); }
}

</style>

</head>

<body>

<!-- ðŸ” LOGIN PROTECTION -->
<script>
if(localStorage.getItem("loggedIn") !== "true"){
    window.location.href = "login.html";
}
</script>

<header>
  <div id="welcomeUser"></div>
  <div>
    <button onclick="clearChat()">Clear</button>
    <button id="voiceToggle" onclick="toggleVoice()">ðŸ”Š</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<main id="chatbox"></main>

<div id="input-area">
  <input type="text" id="userInput" placeholder="Ask something..." />
  <button id="sendBtn">Send</button>
  <input type="file" id="fileInput" accept="image/*,.pdf" hidden>
  <button onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
  <button id="micBtn">ðŸŽ¤</button>

</div>

<script>
  document.getElementById("fileInput").addEventListener("change", function(e){

    const file = e.target.files[0];
    if(!file) return;

    appendMessage("ðŸ“Ž Uploaded: " + file.name, "user");

    if(file.type.startsWith("image/")){
        const reader = new FileReader();
        reader.onload = function(event){
            const img = document.createElement("img");
            img.src = event.target.result;
            img.style.maxWidth = "200px";
            img.style.borderRadius = "12px";
            img.style.marginTop = "8px";
            chatbox.appendChild(img);
        };
        reader.readAsDataURL(file);
    }

    if(file.type === "application/pdf"){
        appendMessage("PDF uploaded. (Preview feature can be added with backend)", "ai");
    }
});

const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const chatbox = document.getElementById("chatbox");
let voiceEnabled = true;

function toggleVoice(){
    voiceEnabled = !voiceEnabled;
    localStorage.setItem("voiceEnabled", voiceEnabled);

    const btn = document.getElementById("voiceToggle");

    if(voiceEnabled){
        btn.textContent = "ðŸ”Š";
    } else {
        btn.textContent = "ðŸ”‡";
        speechSynthesis.cancel(); // stop speaking immediately
    }
}

function logout(){
    localStorage.removeItem("loggedIn");
    window.location.href = "login.html";
}

function clearChat(){
    const username = localStorage.getItem("username") || "guest";
    localStorage.removeItem("chat_" + username);
    chatbox.innerHTML = "";
}

function getTimestamp(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function appendMessage(text, from='ai', save=true){
    const username = localStorage.getItem("username") || "guest";

    const p = document.createElement("p");
    const time = document.createElement("span");
    time.className = "timestamp";
    time.textContent = getTimestamp();

    p.textContent = (from === "user" ? "ðŸ§‘ " : "ðŸ¤– ") + text;
    p.className = from === "user" ? "user-msg" : "ai-msg";

    p.appendChild(time);
    chatbox.appendChild(p);
    chatbox.scrollTop = chatbox.scrollHeight;

    if(save){
        let chats = JSON.parse(localStorage.getItem("chat_" + username)) || [];
        chats.push({text, from, time: time.textContent});
        localStorage.setItem("chat_" + username, JSON.stringify(chats));
    }
}

function loadChatHistory(){
    const username = localStorage.getItem("username") || "guest";
    let chats = JSON.parse(localStorage.getItem("chat_" + username)) || [];

    chats.forEach(chat=>{
        appendMessage(chat.text, chat.from, false);
    });
}
function cleanQuery(query){
    return query
        .replace(/tell me about/gi, "")
        .replace(/who is/gi, "")
        .replace(/about/gi, "")
        .trim();
}

async function fetchWiki(query) {

    query = cleanQuery(query);

    // STEP 1: OpenSearch for best suggestions
    const openUrl = `https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=5&namespace=0&format=json&origin=*`;

    const openResponse = await fetch(openUrl);
    const openData = await openResponse.json();

    if (!openData[1].length) {
        throw new Error("No results found");
    }

    // STEP 2: Try first 5 titles and skip disambiguation
    for (let title of openData[1]) {

        const extractUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts|pageimages&exintro=true&explaintext=true&pithumbsize=400&titles=${encodeURIComponent(title)}&format=json&origin=*`;

        const extractResponse = await fetch(extractUrl);
        const extractData = await extractResponse.json();

        const page = Object.values(extractData.query.pages)[0];

        if (
            page.extract &&
            !page.extract.toLowerCase().includes("may refer to")
        ) {
            return {
                text: page.extract,
                image: page.thumbnail ? page.thumbnail.source : null,
                link: `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`
            };
        }
    }

    throw new Error("No proper page found");
}



async function handleQuery(){

    const input = userInput.value.trim();
    if(!input) return;

    appendMessage(input, "user");
    userInput.value = "";

    try{

        const result = await fetchWiki(input);

        appendMessage(result.text, "ai");

        if(result.image){
            const img = document.createElement("img");
            img.src = result.image;
            img.style.maxWidth = "250px";
            img.style.borderRadius = "12px";
            img.style.marginTop = "10px";
            chatbox.appendChild(img);
        }

        const link = document.createElement("a");
        link.href = result.link;
        link.target = "_blank";
        link.innerText = "ðŸ”— Read more on Wikipedia";
        link.style.display = "block";
        link.style.marginTop = "6px";
        link.style.color = "#4caf50";
        chatbox.appendChild(link);

        speak(result.text);

    } catch (error){

        console.error(error);
        appendMessage("No proper information found.", "ai");

    }
}

function speak(text){
    if(!voiceEnabled) return;

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    speechSynthesis.speak(utter);
}


sendBtn.onclick = handleQuery;

userInput.addEventListener("keydown", e=>{
    if(e.key === "Enter") handleQuery();
});

micBtn.onclick = ()=>{
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition){
        alert("Voice not supported");
        return;
    }
    const recog = new SpeechRecognition();
    recog.lang="en-US";
    recog.onresult = e=>{
        userInput.value = e.results[0][0].transcript;
        handleQuery();
    };
    recog.start();
};

window.onload = ()=>{
    const username = localStorage.getItem("username") || "User";
    document.getElementById("welcomeUser").innerText = "Welcome, " + username;
    voiceEnabled = localStorage.getItem("voiceEnabled") !== "false";
    document.getElementById("voiceToggle").textContent = voiceEnabled ? "ðŸ”Š" : "ðŸ”‡";

    loadChatHistory();
};
</script>

</body>
</html>
